fabric.Image.filters.BrightnessContrast=fabric.util.createClass(fabric.Image.filters.BaseFilter,{type:"BrightnessContrast",initialize:function(n){n||(n={});this.contrast=n.contrast||0;this.brightness=n.brightness||0},applyTo:function(n){var h=1+Math.min(150,Math.max(-150,this.brightness))/150,f=Math.max(0,this.contrast+1),c=n.getContext("2d"),l=c.getImageData(0,0,n.width,n.height),t=l.data,a=n.width*n.height,u=a*4,v,y,i,r,e,o,s;for(f!=-1?(i=h*f,r=-f*128+128):(i=h,r=0);a--;)t[u]=(e=t[u-=4]*i+r)>255?255:e<0?0:e,t[v]=(o=t[v=u+1]*i+r)>255?255:o<0?0:o,t[y]=(s=t[y=u+2]*i+r)>255?255:s<0?0:s;c.putImageData(l,0,0)},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"),{contrast:this.contrast,brightness:this.brightness})}});fabric.Image.filters.BrightnessContrast.async=!0;fabric.Image.filters.BrightnessContrast.fromObject=function(n,t){fabric.util.loadImage(n.src,function(i){fabric.Image.prototype._initFilters.call(n,n,function(){var r=new fabric.Image.filters.BrightnessContrast(i,n);r.contrast=1;t&&t(r)})},null,n.crossOrigin)};var canvas=null;$(document).ready(function(){function e(){this.classList.add("img_dragging")}function o(n){return n.preventDefault&&n.preventDefault(),n.dataTransfer.dropEffect="copy",!1}function s(){this.classList.add("over")}function h(){this.classList.remove("over")}function c(n){return n.stopPropagation&&n.stopPropagation(),n.dataTransfer.items[0].getAsString(function(t){var i=new Image;i.src=t;imgToCanvas(i,n.layerX,n.layerY)}),!1}function l(){this.classList.remove("img_dragging")}function t(n,t){var i=canvas.getActiveObject();i.filters[n]=t;i.applyFilters(canvas.renderAll.bind(canvas))}function a(n){if(!n.type.match(/image.*/)){console.log("The dropped file is not an image: ",n.type);return}var t=new FileReader;t.onload=addInputOnCanvas;t.readAsDataURL(n)}var n;fabric.Object.prototype.transparentCorners=!1;fabric.Object.prototype.padding=1;canvas=new fabric.Canvas("c");f=fabric.Image.filters;canvas.selection=!1;fabric.Image.fromURL(document.getElementById("bg").href,function(n){canvas.backgroundImage=n;canvas.backgroundImage.width=1e3;canvas.backgroundImage.height=600;canvas.renderAll()});_model.JSONContent!=null&&canvas.loadFromJSON(_model.JSONContent);var u=document.getElementById("drawing-mode"),v=document.getElementById("drawing-mode-options"),i=document.getElementById("drawing-color"),y=document.getElementById("clear-canvas"),r=document.getElementById("drawing-line-width");u.onclick=function(){canvas.isDrawingMode=!canvas.isDrawingMode;u.innerHTML=canvas.isDrawingMode?"Cancel drawing mode":"Enter drawing mode"};$("drawing-mode-selector").onchange=function(){canvas.freeDrawingBrush=this.value==="hline"?vLinePatternBrush:this.value==="vline"?hLinePatternBrush:this.value==="square"?squarePatternBrush:this.value==="diamond"?diamondPatternBrush:this.value==="texture"?texturePatternBrush:new fabric[this.value+"Brush"](canvas);canvas.freeDrawingBrush&&(canvas.freeDrawingBrush.color=i.value,canvas.freeDrawingBrush.width=parseInt(r.value,10)||1,canvas.freeDrawingBrush.shadowBlur=parseInt(drawingShadowWidth.value,10)||0)};i.onchange=function(){canvas.freeDrawingBrush.color=this.value};r.onchange=function(){canvas.freeDrawingBrush.width=parseInt(this.value,10)||1;this.previousSibling.innerHTML=this.value};canvas.freeDrawingBrush&&(canvas.freeDrawingBrush.color=i.value,canvas.freeDrawingBrush.width=parseInt(r.value,10)||1);canvas.setBackgroundColor("rgb(255, 255, 255)",canvas.renderAll.bind(canvas));$(document).ajaxStart(function(){$("#loading-img").css("display","block")});$(".search form").submit(function(){return $(".search li").remove(),$.getJSON("https://api.flickr.com/services/feeds/photos_public.gne?tags="+$(".search input[name=q]").val()+"&format=json&jsoncallback=?",function(n){$.each(n.items,function(n,t){var i=$("<img draggable=true />").attr("src",t.media.m);return i.attr("title",t.title),$("<li><\/li>").append(i).appendTo(".search ul"),n==8?!1:void 0})}),!1});$(document).ajaxStop(function(){if($("#loading-img").css("display","none"),Modernizr.draganddrop){var n=document.querySelectorAll("#images img");[].forEach.call(n,function(n){n.addEventListener("dragstart",e,!1);n.addEventListener("dragend",l,!1)})}});$(".search img").live("click",function(){imgToCanvas(this,0,0)});$(".bg-imgs img").live("click",function(){var n=this.src;canvas.setBackgroundImage(n,canvas.renderAll.bind(canvas))});imgToCanvas=function(n,t,i){var r=n.src,u=window.location.pathname,f=$.ajax({type:"POST",url:"../UploadImage",data:'{ "url" : "'+r+'", "path" : "'+u+'" }',contentType:"application/json; charset=utf-8",dataType:"json",async:!1}).responseText;fabric.Image.fromURL(f,function(n){canvas.add(n).renderAll();canvas.setActiveObject(n)},{left:t,top:i})};canvas.on({"object:selected":function(){var t,n;if(fabric.util.toArray(document.getElementsByClassName("filter")).forEach(function(n){n.disabled=!1}),t=["grayscale","sepia","sepia2","BrightnessContrast"],canvas.getActiveObject().type==="image")for(n=0;n<t.length;n++)document.getElementsByClassName("filter")[n].checked=!!canvas.getActiveObject().filters[n];else fabric.util.toArray(document.getElementsByClassName("filter")).forEach(function(n){n.disabled=!0;n.checked=!1})},"selection:cleared":function(){fabric.util.toArray(document.getElementsByClassName("filter")).forEach(function(n){n.disabled=!0;n.checked=!1})}});n=document.getElementById("canvas-container");n.addEventListener("dragenter",s,!1);n.addEventListener("dragover",o,!1);n.addEventListener("dragleave",h,!1);n.addEventListener("drop",function(n){n.preventDefault();n.dataTransfer.files[0]!=null?a(n.dataTransfer.files[0]):c(n)},!1);toggleGray=function(n){t(0,n.checked&&new f.Grayscale)};toggleSepia=function(n){t(1,n.checked&&new f.Sepia)};toggleSepia2=function(n){t(2,n.checked&&new f.Sepia2)};toggleContrast=function(n){t(3,n.checked&&new f.BrightnessContrast({contrast:1,brightness:0}))};$(".remove").click(function(){var n=canvas.getActiveObject();n!=null&&canvas.remove(n)});$(".up").click(function(){var n=canvas.getActiveObject();n!=null&&canvas.bringForward(n)});$(".down").click(function(){var n=canvas.getActiveObject();n!=null&&canvas.sendBackwards(n)});$(".top").click(function(){var n=canvas.getActiveObject();n!=null&&canvas.bringToFront(n)});$(".bot").click(function(){var n=canvas.getActiveObject();n!=null&&canvas.sendToBack(n)});save=function(){$("#JSONContent").val(JSON.stringify(canvas));$("#thumbnail").val(compileImage())};compileImage=function(){return canvas.deactivateAll().renderAll(),canvas.toDataURL("image/png").replace("image/png","image/octet-stream")};saveAsFile=function(){var n=document.createElement("a");n.download="mycollage.png";n.href=compileImage();n.click()};uploadImage=function(n){if(n.files&&n.files[0]){var t=new FileReader;t.onload=addInputOnCanvas;t.readAsDataURL(n.files[0])}};addInputOnCanvas=function(n){fabric.Image.fromURL(n.target.result,function(n){canvas.add(n).renderAll();canvas.setActiveObject(n)})}});